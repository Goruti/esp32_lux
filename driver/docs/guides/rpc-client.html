

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing an RPC Client Driver &mdash; SmartThings Edge Device Drivers  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="SmartThings Edge Device Drivers  documentation" href="../index.html"/>
        <link rel="up" title="&lt;no title&gt;" href="index.html"/>
        <link rel="next" title="&lt;no title&gt;" href="../reference/index.html"/>
        <link rel="prev" title="LAN Edge Device Driver Development Guide" href="lan.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> SmartThings Edge Device Drivers
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Guides:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="first-driver.html">Writing your first Lua driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="package.html">Package Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="lan.html">LAN Edge Device Driver Development Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing an RPC Client Driver</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="#strategy">Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tool-setup">Tool setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-a-driver">Writing a driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-a-library">Writing a Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discovering-things">Discovering Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="#turning-it-into-a-driver">Turning it into a driver</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">References:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lua_environment.html">Lua Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log.html">Logging Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">Utils Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../buf.html">Buffer Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/zigbee.html">Zigbee Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zwave/zwave.html">Z-Wave Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers.html">Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../capabilities.html">Capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../device.html">Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dispatchers.html">Dispatchers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver_tests.html">Driver Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datastore.html">Datastore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../socket.html">Socket Library</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SmartThings Edge Device Drivers</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">&lt;no title&gt;</a> &raquo;</li>
        
      <li>Writing an RPC Client Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/guides/rpc-client.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-an-rpc-client-driver">
<h1>Writing an RPC Client Driver<a class="headerlink" href="#writing-an-rpc-client-driver" title="Permalink to this headline">¶</a></h1>
<p>Working notes: This driver has a few shortcomings related to reliability and
performance. It should really have the following added before we go public with
this:</p>
<ol class="arabic simple">
<li><p>If a connection dies, we need to clean it up and probably try to re-connect
in-place. Right now you’ll probably get errors forever after the first
connection dies.</p></li>
<li><p>SSDP search response caching. Right now each device does its own search, to
which every device replies. So we end up with n^2 search responses at startup
and don’t even take advantage of that duplication at all.</p></li>
<li><p>A more complete description of how cosock/threading works and what users need
to worry about.</p></li>
<li><p>Possibly a better walk through of exactly how to use the sockets’ interfaces
for those who aren’t familiar with posix sockets.</p></li>
</ol>
<p>This guide will help you write a SmartThings Edge Driver integrating a LAN
device that exposes a basic RPC (Remote Procedure Call) server API. This driver
will discover the device/server on the network and then act as a client to the
server.</p>
<p>We’ll start by setting up discovery, which will use a protocol called SSDP.
This sends out a multicast packet onto your network. Your network will then send
that packet to any devices on your network that are joined to the mulitcast
group used by SSDP.</p>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>A Remote Procedure Call API implemented over a network connection is typically a
message passing system implemented with a request-response response model that
uses messages representing the input and output of a function call.</p>
<p>For our sample device, we will use an API where requests look like the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1482</span><span class="p">,</span><span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;setattr&quot;</span><span class="p">,</span><span class="s2">&quot;params&quot;</span><span class="p">:[{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span><span class="s2">&quot;off&quot;</span><span class="p">}]}</span>
</pre></div>
</div>
<p>and responses look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1482</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:[</span><span class="s2">&quot;ok&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>Each request or response is a line of JSON text, terminated by a LF (aka “n”,
not shown).</p>
<p>A request includes:</p>
<ol class="arabic simple">
<li><p>An ID chosen by the requester, in this case a number, to identify the
request: <code class="docutils literal notranslate"><span class="pre">id</span></code></p></li>
<li><p>The name of the method to be called: <code class="docutils literal notranslate"><span class="pre">method</span></code></p></li>
<li><p>The list of parameters to be passed to the method: <code class="docutils literal notranslate"><span class="pre">params</span></code></p></li>
</ol>
<p>A response includes:</p>
<ol class="arabic simple">
<li><p>The ID from the request to allow the client to associate a response to a
request: <code class="docutils literal notranslate"><span class="pre">id</span></code></p></li>
<li><p>A list of zero or more results returned from calling the method: <code class="docutils literal notranslate"><span class="pre">results</span></code></p></li>
</ol>
<p>Essentially, this example is an RPC client telling an RPC server to run the
method <code class="docutils literal notranslate"><span class="pre">setattr({power</span> <span class="pre">=</span> <span class="pre">&quot;off&quot;})</span></code> with the RPC server responding that that
method returned one result which was <code class="docutils literal notranslate"><span class="pre">&quot;ok&quot;</span></code>.</p>
<p>In our simple API, the <code class="docutils literal notranslate"><span class="pre">setattr</span></code> method is the only method that is available
to call. It takes a single parameter which is a map of attributes to set and the
values to set them to.</p>
<p>In addition to this request/response system, the RPC server will notify all
currently connected clients any time any client sets any attribute. In a real
world device this would allow us to update the state of a device in the
SmartThings platform when the device is controlled by some external means, such
as a manufacturer’s app or some scheduling system built into the device.</p>
<p>Notifications look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;attr&quot;</span><span class="p">,</span><span class="s2">&quot;params&quot;</span><span class="p">:[{</span><span class="s2">&quot;power&quot;</span><span class="p">:</span><span class="s2">&quot;off&quot;</span><span class="p">}]}</span>
</pre></div>
</div>
<p>The notification is just like a request that the client would send, except it
doesn’t have an <code class="docutils literal notranslate"><span class="pre">id</span></code> because the server doesn’t expect the client to respond.</p>
</div>
<div class="section" id="strategy">
<h2>Strategy<a class="headerlink" href="#strategy" title="Permalink to this headline">¶</a></h2>
<p>Now that we have the protocol defined, we will discuss how to use it within the
context of a SmartThings Edge Device Driver.</p>
<p>This API is one of the more complicated setups to accommodate without making a
mess of our code. This is mainly due to the fact that the same socket is used
for request-response as well as async notifications. We’re going to need to do
some special setup to be able to reliably handle both.</p>
<p>Before we can implement this, we need a device which uses the protocol outlined
above.</p>
</div>
<div class="section" id="tool-setup">
<h2>Tool setup<a class="headerlink" href="#tool-setup" title="Permalink to this headline">¶</a></h2>
<p>This guide requires no specific hardware. Instead, we will use an external
network device simulator that you can run on your computer called <a class="reference external" href="https://github.com/SmartThingsCommunity/ThingSim">ThingSim</a>. This can be easily
installed using <a class="reference external" href="https://luarocks.org">LuaRocks</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">SmartThingsCommunity</span><span class="o">/</span><span class="n">SmartThingsEdgeDriversBeta</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">SmartThingsEdgeDriversBeta</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">thingsim</span><span class="o">/</span>
<span class="n">luarocks</span> <span class="n">make</span> <span class="o">--</span><span class="n">local</span> <span class="n">thingsim</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="mf">1.</span><span class="n">rockspec</span>

<span class="c1"># TODO: Publish to luarocks once we can publish this in a public repo so this works:</span>
<span class="c1">#luarocks install thingsim</span>
</pre></div>
</div>
<p>You should now be able to run the thingsim command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">thingsim</span>
</pre></div>
</div>
<p>If it doesn’t work make sure you’ve configured your $PATH properly for luarocks.
TODO: find or write a guide</p>
<p>We’ll also go ahead and add a couple of things to simulate now that we’ll use
later. Run <code class="docutils literal notranslate"><span class="pre">thingsim</span> <span class="pre">add</span></code> once for each simulated thing you want to add, for
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">thingsim</span> <span class="n">add</span> <span class="n">bulb</span> <span class="o">--</span><span class="n">name</span> <span class="s2">&quot;Imaginary Bulb #1&quot;</span>
<span class="n">thingsim</span> <span class="n">add</span> <span class="n">bulb</span> <span class="o">--</span><span class="n">name</span> <span class="s2">&quot;Imaginary Bulb #2&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-a-driver">
<h2>Writing a driver<a class="headerlink" href="#writing-a-driver" title="Permalink to this headline">¶</a></h2>
<p>The general process we’re going to use for writing our driver is:</p>
<ol class="arabic simple">
<li><p>Write some, probably messy, code that in some way talks to your device.</p></li>
<li><p>Refactor that code into something that can be used as a library.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">require</span></code> that library into the skeleton example driver.</p></li>
<li><p>Hookup command handlers to your library’s control commands.</p></li>
<li><p>Hookup attribute reporting to your library’s events.</p></li>
</ol>
</div>
<div class="section" id="writing-a-library">
<h2>Writing a Library<a class="headerlink" href="#writing-a-library" title="Permalink to this headline">¶</a></h2>
<p>The ideal way to construct a library is to write it using LuaSockets.</p>
<p>To create a library for your LAN-connected device, you’ll be using a POSIX-like
sockets interface as implemented by LuaSocket.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The SmartThings Platform uses a library called <a class="reference external" href="https://github.com/cosock/cosock">cosock</a> which allows you to write single-threaded
blocking socket code. Behind the scenes, it interleaves different events each
running while other events are waiting on data from the network. This means
that you only need to write synchronous blocking network calls in each event
handler, but do not need to worry about network calls in one blocked event
preventing processing in another event handler.</p>
</div>
<p>To start creating our library, we’re going to start off with a basic skeleton of
a Lua module that implements an object-oriented pattern. We’ll choose to write
all this in a file called <code class="docutils literal notranslate"><span class="pre">rpcclient.lua</span></code>, and as with all the code in our
driver it will go into the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory.</p>
<p>Our library will return a table that has a <code class="docutils literal notranslate"><span class="pre">new</span></code> function which will create a
new instance of a client object that represents a connection to one device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">table</span> <span class="n">that</span> <span class="n">both</span> <span class="n">holds</span> <span class="n">our</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">represents</span> <span class="n">our</span> <span class="k">class</span>
<span class="nc">local</span> <span class="n">client</span> <span class="o">=</span> <span class="p">{}</span>

<span class="o">--</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">client</span> <span class="nb">object</span>
<span class="n">function</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
  <span class="n">local</span> <span class="n">o</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">setmetatable</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span> <span class="o">=</span> <span class="n">client</span><span class="p">})</span>
  <span class="k">return</span> <span class="n">o</span>
<span class="n">end</span>

<span class="k">return</span> <span class="n">client</span>
</pre></div>
</div>
<p>This uses some slightly advanced lua code. We’re returning the table <code class="docutils literal notranslate"><span class="pre">o</span></code>,
which is just an empty table. However since we’re calling <code class="docutils literal notranslate"><span class="pre">setmetatable</span></code> with
a metatable that has the value of <code class="docutils literal notranslate"><span class="pre">__index</span></code> set to our <code class="docutils literal notranslate"><span class="pre">client</span></code> table, we’ll
be able to write code that does:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">myclient</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">myclient</span><span class="p">:</span><span class="n">foo</span><span class="p">()</span>
</pre></div>
</div>
<p>And lua will call the function named <code class="docutils literal notranslate"><span class="pre">foo</span></code> that we’ve added as <code class="docutils literal notranslate"><span class="pre">foo</span></code>.
Additionally since we’re using <code class="docutils literal notranslate"><span class="pre">:</span></code> instead of <code class="docutils literal notranslate"><span class="pre">.</span></code> to call the function it
will set the variable <code class="docutils literal notranslate"><span class="pre">self</span></code> inside <code class="docutils literal notranslate"><span class="pre">foo</span></code> to be <code class="docutils literal notranslate"><span class="pre">myclient</span></code>. This will
allow us to access the table we know as <code class="docutils literal notranslate"><span class="pre">myclient</span></code> using the variable
<code class="docutils literal notranslate"><span class="pre">self</span></code> and anything we’ve stored in it.</p>
<p>For more information about how metatables work, see <cite>Chapter 13 of Programming
in Lua First Edition &lt;https://www.lua.org/pil/13.html&gt;</cite> (Or if you own a copy,
see Chapter 20 of Programming in Lua Fourth Edition, which was written along
side the exact version of Lua we use.)</p>
<p>In a moment we’re going to start adding functions to our <code class="docutils literal notranslate"><span class="pre">client</span></code> table that
users of our library can use to make RPC calls to the device each client
represents. But, first, we know that each RPC call is going to be doing exactly
the same thing as every other call to actually send the request and wait for the
response. Let’s make a common internal function that each can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>-- internal function that actually performs the RPC on the network
function client:_call(method, ...)
  -- new request, new id
  self.lat_req_id = self.last_req_id + 1

  -- format call as table
  local request = {
    id = self.last_req_id,
    method = method,
    params = {...}
  }

  -- encode the call as a json-formatted string
  local requeststr = json.encode(request)

  -- send our encoded request, terminated by a newline character
  local bytessent, err = self.sock:send(requeststr..&quot;\n&quot;)
  assert(bytessent, &quot;failed to send request&quot;)
  assert(bytessent == #requeststr + 1, &quot;request only partially sent&quot;)

  while true do
    -- by default `receive` reads a line of data, perfect for our protocol
    local line, err = self.sock:receive()
    assert(line, &quot;failed to get response&quot;)

    -- decode the response into a lua table
    local resp, cont, err = json.decode(line)
    assert(resp, &quot;failed to parse response&quot;)

    if resp.id then
      assert(resp.id == call.id, &quot;unexpected response&quot;)

      -- return the result of the call back to the caller
      return table.unpack(resp.result)
    else
      -- a &quot;resp&quot; without an id is a notification, ignore for now
      -- and let the loop take us back around to try again
    end
  end
end
</pre></div>
</div>
<p>The comments of the above code snippet walk you through each step that it is
taking. This is a very common pattern in all network device communication. In
one form or another, drivers will <code class="docutils literal notranslate"><span class="pre">send</span></code> some piece of new information,
whether it’s a request for some information or a command to change state,
followed by waiting to <code class="docutils literal notranslate"><span class="pre">receive</span></code> a response to know that it got your request
and responded either with the information you asked for or to confirm it took
the action you requested.</p>
<p>You may have noticed that we’re referencing things like <code class="docutils literal notranslate"><span class="pre">self.sock</span></code> and
<code class="docutils literal notranslate"><span class="pre">self.last_req_id</span></code> in our <code class="docutils literal notranslate"><span class="pre">_call</span></code> method. But these values are <code class="docutils literal notranslate"><span class="pre">nil</span></code>
because we haven’t set them to anything. Let’s rectify that now. Lets go back
to our <code class="docutils literal notranslate"><span class="pre">new</span></code> function and setup our socket and a make place to keep track of
which request IDs we’ve used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
  <span class="n">local</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">tcp</span><span class="p">()</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">local</span> <span class="n">o</span> <span class="o">=</span> <span class="p">{</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span><span class="p">,</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span> <span class="n">last_req_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="n">setmetatable</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span> <span class="o">=</span> <span class="n">client</span><span class="p">})</span>
  <span class="k">return</span> <span class="n">o</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Now that we have our common behaviors implemented, lets create a function that
uses it for each call we want to be able to make over our RPC API. In this
example we only support two calls: <code class="docutils literal notranslate"><span class="pre">setattr</span></code> to set attributes of the device,
and <code class="docutils literal notranslate"><span class="pre">getattr</span></code> to get the current value of an attribute. The only attribute
we’ll support is <code class="docutils literal notranslate"><span class="pre">power</span></code> which controls whether our imaginary lightbulb is on
or off.</p>
<p>Here is how we’ll implement our calls:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>-- `setattr` RPC
--
-- sets attributes on the thing
function client:setattr(attrmap)
  return self:_call(&quot;setattr&quot;, attrmap)
end

-- `getattr` RPC
--
-- gets the current value of attributes of thing
function client:getattr(attrlist)
  return self:_call(&quot;getattr&quot;, attrlist)
end
</pre></div>
</div>
<p>To test out how this works, we’ll create a file called <code class="docutils literal notranslate"><span class="pre">call.lua</span></code> in the
driver’s <code class="docutils literal notranslate"><span class="pre">src</span></code> directory. The code we write here won’t actually be used by the
driver, we’ll just call it manually on a PC to make sure everything is working.</p>
<p>This is the file we will write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">client</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;rpcclient&quot;</span>

<span class="n">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">86753</span><span class="p">)</span>

<span class="nb">print</span><span class="p">((</span><span class="n">c</span><span class="p">:</span><span class="nb">setattr</span><span class="p">{</span><span class="n">power</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">}))</span>
</pre></div>
</div>
<p>You’ll need to replace the port number (the last param) in the <code class="docutils literal notranslate"><span class="pre">client.new</span></code>
function with the port that ThingSim tells you it has bound to.  To retrieve
that port number, we’ll need to startup ThingSim with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">thingsim</span> <span class="n">run</span>
</pre></div>
</div>
<p>Assuming you have at least one device added, you should see at least one line
that looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpcserver</span> <span class="n">started</span> <span class="k">for</span> <span class="s1">&#39;My Thing&#39;</span> <span class="n">on</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.42</span><span class="p">:</span><span class="mi">86753</span>
</pre></div>
</div>
<p>If you see that message printed more than once, pick any line. Put the port
number from this (that’s the number after the <code class="docutils literal notranslate"><span class="pre">:</span></code>) in the call to
<code class="docutils literal notranslate"><span class="pre">client.new</span></code> in the <code class="docutils literal notranslate"><span class="pre">call.lua</span></code> script we just created.</p>
<p>You’ll need to leave this running for the next command and anytime you want your
driver to be accessing your devices. For any further commands that aren’t
calling <code class="docutils literal notranslate"><span class="pre">thingsim</span></code> you’ll want to open another terminal and run them there.</p>
<p>Now you should be able to run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lua</span> <span class="n">call</span><span class="o">.</span><span class="n">lua</span>
</pre></div>
</div>
<p>Which should output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ok</span>
</pre></div>
</div>
<p>Congratulations, you have just controlled your simulated device from the
beginnings of your custom driver.</p>
</div>
<div class="section" id="discovering-things">
<h2>Discovering Things<a class="headerlink" href="#discovering-things" title="Permalink to this headline">¶</a></h2>
<p>Hard-coding an IP address might work for a one-off device, but is not an ideal
solution. We need a way of automatically finding a device on the network. Both
for initial discovery, as well as finding the address of a device we’ve already
talked to which has been given a new address by the network.</p>
<p>ThingSim provides a mechanism for doing just that. It uses a protocol called
<a class="reference external" href="https://en.wikipedia.org/wiki/Simple_Service_Discovery_Protocol">SSDP (Simple Service Discovery Protocol)</a> where it
listens for <a class="reference external" href="https://en.wikipedia.org/wiki/Multicast">multicast</a> search
requests and responds to any that denote they are looking for a “ThingSim”
device.</p>
<p>SSDP isn’t defined as standalone protocol, but as a part of UPnP. You can find
its specification in chapter 1 of the <cite>UPnP Device Architechure Spec
&lt;https://openconnectivity.org/upnp-specs/UPnP-arch-DeviceArchitecture-v2.0-20200417.pdf&gt;</cite>.</p>
<p>The device driver standard library will at some point include an SSDP protocol
implementation, but we’ll directly implement a simple version here as a learning
exercise in case you need to implement a discovery protocol we don’t provide.</p>
<p>SSDP, like similar protocols like mDNS, uses a method of sending UDP packets to
multiple devices at the same time called Multicast. Multicast communication
allows any number of devices on the local network to register their interest in
receiving packets sent to a certain group.</p>
<p>Below is a library file that will perform the right multicast query and wait for
any number of responses. It also parses out some custom fields like the IP
address, port, and the name of the device, if set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;socket&quot;</span>

<span class="n">local</span> <span class="n">SEARCH_RESPONSE_WAIT</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">--</span> <span class="n">seconds</span><span class="p">,</span> <span class="nb">max</span> <span class="n">time</span> <span class="n">devices</span> <span class="n">will</span> <span class="n">wait</span> <span class="n">before</span> <span class="n">responding</span>

<span class="o">--------------------------------------------------------------------------------------------</span>
<span class="o">--</span> <span class="n">ThingSim</span> <span class="n">device</span> <span class="n">discovery</span>
<span class="o">--------------------------------------------------------------------------------------------</span>

<span class="n">local</span> <span class="n">looking_for_all</span> <span class="o">=</span> <span class="n">setmetatable</span><span class="p">({},</span> <span class="p">{</span><span class="n">__index</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="k">return</span> <span class="n">true</span> <span class="n">end</span><span class="p">})</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">process_response</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">gmatch</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;([</span><span class="si">%g</span><span class="s2">]+): ([</span><span class="si">%g</span><span class="s2"> ]*)</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="n">do</span>
    <span class="n">info</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
  <span class="n">end</span>
  <span class="k">return</span> <span class="n">info</span>
<span class="n">end</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">device_discovery_metadata_generator</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">looking_for</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">local</span> <span class="n">number_looking_for</span>
  <span class="n">local</span> <span class="n">number_found</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="n">thing_ids</span> <span class="o">~=</span> <span class="n">nil</span> <span class="n">then</span>
    <span class="n">number_looking_for</span> <span class="o">=</span> <span class="c1">#thing_ids</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">)</span> <span class="n">do</span> <span class="n">looking_for</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">true</span> <span class="n">end</span>
  <span class="k">else</span>
    <span class="n">looking_for</span> <span class="o">=</span> <span class="n">looking_for_all</span>
    <span class="n">number_looking_for</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">maxinteger</span>
  <span class="n">end</span>

  <span class="n">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">udp</span><span class="p">()</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">listen_ip</span> <span class="o">=</span> <span class="n">interface</span> <span class="ow">or</span> <span class="s2">&quot;0.0.0.0&quot;</span>
  <span class="n">local</span> <span class="n">listen_port</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="n">local</span> <span class="n">multicast_ip</span> <span class="o">=</span> <span class="s2">&quot;239.255.255.250&quot;</span>
  <span class="n">local</span> <span class="n">multicast_port</span> <span class="o">=</span> <span class="mi">1900</span>
  <span class="n">local</span> <span class="n">multicast_msg</span> <span class="o">=</span>
  <span class="s1">&#39;M-SEARCH * HTTP/1.1</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
  <span class="s1">&#39;HOST: 239.255.255.250:1982</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
  <span class="s1">&#39;MAN: &quot;ssdp:discover&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
  <span class="s1">&#39;MX: &#39;</span><span class="o">..</span><span class="n">SEARCH_RESPONSE_WAIT</span><span class="o">..</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
  <span class="s1">&#39;ST: urn:smartthings-com:device:thingsim:1</span><span class="se">\r\n</span><span class="s1">&#39;</span>

  <span class="o">--</span> <span class="n">Create</span> <span class="n">bind</span> <span class="n">local</span> <span class="n">ip</span> <span class="ow">and</span> <span class="n">port</span>
  <span class="o">--</span> <span class="n">simulator</span> <span class="n">will</span> <span class="n">unicast</span> <span class="n">back</span> <span class="n">to</span> <span class="n">this</span> <span class="n">ip</span> <span class="ow">and</span> <span class="n">port</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">setsockname</span><span class="p">(</span><span class="n">listen_ip</span><span class="p">,</span> <span class="n">listen_port</span><span class="p">))</span>
  <span class="o">--</span> <span class="n">add</span> <span class="n">a</span> <span class="n">second</span> <span class="n">to</span> <span class="n">timeout</span> <span class="n">to</span> <span class="n">account</span> <span class="k">for</span> <span class="n">network</span> <span class="o">&amp;</span> <span class="n">processing</span> <span class="n">latency</span>
  <span class="n">local</span> <span class="n">timeouttime</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gettime</span><span class="p">()</span> <span class="o">+</span> <span class="n">SEARCH_RESPONSE_WAIT</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">s</span><span class="p">:</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

  <span class="n">local</span> <span class="n">ids_found</span> <span class="o">=</span> <span class="p">{}</span> <span class="o">--</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">filter</span> <span class="n">duplicates</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">sendto</span><span class="p">(</span><span class="n">multicast_msg</span><span class="p">,</span> <span class="n">multicast_ip</span><span class="p">,</span> <span class="n">multicast_port</span><span class="p">))</span>
  <span class="k">while</span> <span class="n">number_found</span> <span class="o">&lt;</span> <span class="n">number_looking_for</span> <span class="n">do</span>
    <span class="n">local</span> <span class="n">time_remaining</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeouttime</span><span class="o">-</span><span class="n">socket</span><span class="o">.</span><span class="n">gettime</span><span class="p">())</span>
    <span class="n">s</span><span class="p">:</span><span class="n">settimeout</span><span class="p">(</span><span class="n">time_remaining</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">val</span><span class="p">,</span> <span class="n">rip</span><span class="p">,</span> <span class="n">rport</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">receivefrom</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">val</span> <span class="n">then</span>
      <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
      <span class="n">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">process_response</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
      <span class="n">local</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;http://([^,]+):([^/]+)&quot;</span><span class="p">)</span>
      <span class="n">local</span> <span class="n">rpcip</span><span class="p">,</span> <span class="n">rpcport</span> <span class="o">=</span> <span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;rpc.smartthings.com&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;rpc://([^,]+):([^/]+)&quot;</span><span class="p">)</span>
      <span class="n">local</span> <span class="n">httpip</span><span class="p">,</span> <span class="n">httpport</span> <span class="o">=</span> <span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;http.smartthings.com&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;http://([^,]+):([^/]+)&quot;</span><span class="p">)</span>
      <span class="n">local</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;usn&quot;</span><span class="p">]:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;uuid:([^:]+)&quot;</span><span class="p">)</span>
      <span class="n">local</span> <span class="n">name</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;name.smartthings.com&quot;</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">rip</span> <span class="o">~=</span> <span class="n">ip</span> <span class="n">then</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;recieved discovery response with reported &amp; source IP mismatch, ignoring&quot;</span><span class="p">)</span>
      <span class="n">elseif</span> <span class="n">ip</span> <span class="ow">and</span> <span class="n">port</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">looking_for</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ids_found</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="n">then</span>
        <span class="n">ids_found</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">true</span>
              <span class="n">number_found</span> <span class="o">=</span> <span class="n">number_found</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">callback</span><span class="p">({</span><span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span> <span class="n">rpcport</span> <span class="o">=</span> <span class="n">rpcport</span><span class="p">,</span> <span class="n">httpport</span> <span class="o">=</span> <span class="n">httpport</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">})</span>
      <span class="k">else</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found device not looking for:&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">elseif</span> <span class="n">rip</span> <span class="o">==</span> <span class="s2">&quot;timeout&quot;</span> <span class="n">then</span>
      <span class="k">return</span> <span class="n">nil</span>
    <span class="k">else</span>
      <span class="n">error</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;error receving discovery replies: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rip</span><span class="p">))</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">find_cb</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
  <span class="n">device_discovery_metadata_generator</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">find</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">thingsmeta</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">local</span> <span class="n">function</span> <span class="n">cb</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">thingsmeta</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="n">end</span>
  <span class="n">find_cb</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">thingsmeta</span>
<span class="n">end</span>


<span class="k">return</span> <span class="p">{</span>
  <span class="n">find</span> <span class="o">=</span> <span class="n">find</span><span class="p">,</span>
  <span class="n">find_cb</span> <span class="o">=</span> <span class="n">find_cb</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It’s not important to understand everything that is happening in this library
right now. Just know that you can call the <code class="docutils literal notranslate"><span class="pre">find</span></code> function with an optional
list of IDs to filter on to receive a list of tables containing information
about devices that have been found, including the <code class="docutils literal notranslate"><span class="pre">id</span></code>, the <code class="docutils literal notranslate"><span class="pre">ip</span></code>, the
<code class="docutils literal notranslate"><span class="pre">rpcport</span></code>, and the <code class="docutils literal notranslate"><span class="pre">name</span></code> (if set).</p>
<p>This discovery library will let us update our <code class="docutils literal notranslate"><span class="pre">call.lua</span></code> script to discover
and control all ThingSim devices on our network. Let’s update our script to look
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">client</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;rpcclient&quot;</span>
<span class="n">local</span> <span class="n">discovery</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;discovery&quot;</span>

<span class="o">--</span> <span class="n">no</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">find</span> <span class="nb">all</span> <span class="n">devices</span>
<span class="n">local</span> <span class="n">things</span> <span class="o">=</span> <span class="n">discovery</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>

<span class="o">--</span> <span class="n">Loop</span> <span class="n">over</span> <span class="nb">all</span> <span class="n">devices</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">turn</span> <span class="n">them</span> <span class="n">off</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">thing</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">things</span><span class="p">)</span> <span class="n">do</span>
  <span class="n">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">rpcport</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">((</span><span class="n">c</span><span class="p">:</span><span class="nb">setattr</span><span class="p">{</span><span class="n">power</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">}))</span>
<span class="n">end</span>
</pre></div>
</div>
<p>This will send a request out to the network looking for all ThingSim type
devices; after ~3 seconds, we’ll get a list of everything that has responded,
connecting to each device one-by-one and telling it to turn off.</p>
<p>Before we put our library to use, now is a good time to play around and try
doing a few more things with it directly to get a better understanding of what
all it can do. A few things to try:</p>
<ol class="arabic simple">
<li><p>Change it to turn things on.</p></li>
<li><p>Change it to toggle the things on or off (hint: try the <code class="docutils literal notranslate"><span class="pre">getattr</span></code> procedure).</p></li>
<li><p>Run ThingSim on one computer and your test script from another.</p></li>
</ol>
</div>
<div class="section" id="turning-it-into-a-driver">
<h2>Turning it into a driver<a class="headerlink" href="#turning-it-into-a-driver" title="Permalink to this headline">¶</a></h2>
<p>Now that we have a library that is able to interact with our Thing, let’s turn
it into a SmartThings Edge Driver so that it can run on the SmartThings Hub,
take capability commands and turn them into network requests, and take network
events and turn them into capability attribute events.</p>
<p>We’ll start with the driver from the end of the <a class="reference internal" href="first-driver.html"><span class="doc">Writing your first Lua
driver</span></a> guide:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">init</span><span class="o">.</span><span class="n">lua</span>
<span class="n">local</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;st.capabilities&quot;</span>
<span class="n">local</span> <span class="n">Driver</span> <span class="o">=</span> <span class="n">require</span> <span class="s2">&quot;st.driver&quot;</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">handle_on</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Send on command to device&quot;</span><span class="p">)</span>

  <span class="o">--</span> <span class="ow">in</span> <span class="n">most</span> <span class="n">cases</span> <span class="n">this</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">here</span><span class="p">,</span> <span class="n">it</span> <span class="n">should</span> <span class="n">be</span>
  <span class="o">--</span> <span class="n">code</span> <span class="n">parsing</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">device</span>
  <span class="n">device</span><span class="p">:</span><span class="n">emit_event</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">on</span><span class="p">())</span>
<span class="n">end</span>

<span class="n">local</span> <span class="n">function</span> <span class="n">handle_off</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Send off command to device&quot;</span><span class="p">)</span>

  <span class="o">--</span> <span class="ow">in</span> <span class="n">most</span> <span class="n">cases</span> <span class="n">this</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">here</span><span class="p">,</span> <span class="n">it</span> <span class="n">should</span> <span class="n">be</span>
  <span class="o">--</span> <span class="n">code</span> <span class="n">parsing</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">device</span>
  <span class="n">device</span><span class="p">:</span><span class="n">emit_event</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">off</span><span class="p">())</span>
<span class="n">end</span>

<span class="o">--</span> <span class="n">Driver</span> <span class="n">library</span> <span class="n">initialization</span>
<span class="n">local</span> <span class="n">example_driver</span> <span class="o">=</span>
  <span class="n">Driver</span><span class="p">(</span><span class="s2">&quot;example_driver&quot;</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">capability_handlers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span>
      <span class="p">{</span>
        <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle_on</span><span class="p">,</span>
        <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">off</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle_off</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>

<span class="o">--</span> <span class="n">Put</span> <span class="n">other</span> <span class="n">setup</span> <span class="n">code</span> <span class="n">here</span>

<span class="n">example_driver</span><span class="p">:</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>This skeleton driver has the basics for interfacing with the SmartThings
platform. In this section we’ll be adding the code needed for interfacing with
our simulated device using the library we created.</p>
<p>First, we’ll modify the existing capability command handler functions. In both
the handlers for “on” and for “off” we need to make sure we have an active
connection to the Thing’s rpc server. Then we’ll set our <code class="docutils literal notranslate"><span class="pre">power</span></code> attribute to
either <code class="docutils literal notranslate"><span class="pre">on</span></code> or <code class="docutils literal notranslate"><span class="pre">off</span></code> and wait for a reply to see if it worked and emitted
the corresponding switch capability attribute event.</p>
<p>Our on handler function will now look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">function</span> <span class="n">handle_on</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;switch on&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

  <span class="n">local</span> <span class="n">client</span> <span class="o">=</span> <span class="k">assert</span><span class="p">(</span><span class="n">get_thing_client</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">client</span><span class="p">:</span><span class="nb">setattr</span><span class="p">{</span><span class="n">power</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span><span class="p">}</span> <span class="n">then</span>
    <span class="n">device</span><span class="p">:</span><span class="n">emit_event</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">on</span><span class="p">())</span>
  <span class="k">else</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed to set power on&quot;</span><span class="p">)</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>And, similarly, our off handler function will now look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">function</span> <span class="n">handle_off</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;switch off&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

  <span class="n">local</span> <span class="n">client</span> <span class="o">=</span> <span class="k">assert</span><span class="p">(</span><span class="n">get_thing_client</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">client</span><span class="p">:</span><span class="nb">setattr</span><span class="p">{</span><span class="n">power</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">}</span> <span class="n">then</span>
    <span class="n">device</span><span class="p">:</span><span class="n">emit_event</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">off</span><span class="p">())</span>
  <span class="k">else</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed to set power on&quot;</span><span class="p">)</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Let’s next write a helper function for discovering a Thing and creating an
rpcclient for it. Put this as a top level function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">search</span> <span class="n">network</span> <span class="k">for</span> <span class="n">specific</span> <span class="n">thing</span> <span class="n">using</span> <span class="n">custom</span> <span class="n">discovery</span> <span class="n">library</span>
<span class="n">local</span> <span class="n">function</span> <span class="n">find_thing</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="o">--</span> <span class="n">use</span> <span class="n">our</span> <span class="n">discovery</span> <span class="n">function</span> <span class="n">to</span> <span class="n">find</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">our</span> <span class="n">devices</span>
  <span class="n">local</span> <span class="n">things</span> <span class="o">=</span> <span class="n">discovery</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="nb">id</span><span class="p">})</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">things</span> <span class="n">then</span>
    <span class="o">--</span> <span class="k">return</span> <span class="n">early</span> <span class="k">if</span> <span class="n">discovery</span> <span class="n">fails</span>
    <span class="k">return</span> <span class="n">nil</span>
  <span class="n">end</span>
  <span class="o">--</span> <span class="k">return</span> <span class="n">the</span> <span class="n">first</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">our</span> <span class="n">things</span> <span class="nb">list</span>
  <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thing_ids</span><span class="p">)</span>
<span class="n">end</span>

<span class="o">--</span> <span class="n">get</span> <span class="n">an</span> <span class="n">rpc</span> <span class="n">client</span> <span class="k">for</span> <span class="n">thing</span> <span class="k">if</span> <span class="n">thing</span> <span class="ow">is</span> <span class="n">reachable</span> <span class="n">on</span> <span class="n">the</span> <span class="n">network</span>
<span class="n">local</span> <span class="n">function</span> <span class="n">get_thing_client</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">thingclient</span> <span class="o">=</span> <span class="n">device</span><span class="p">:</span><span class="n">get_field</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">thingclient</span> <span class="n">then</span>
    <span class="n">local</span> <span class="n">thing</span> <span class="o">=</span> <span class="n">find_thing</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">device_network_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thing</span> <span class="n">then</span>
      <span class="n">thingclient</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">rpcport</span><span class="p">)</span>
      <span class="n">device</span><span class="p">:</span><span class="n">set_field</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>

      <span class="o">--</span> <span class="n">tell</span> <span class="n">device</span> <span class="n">health</span> <span class="n">to</span> <span class="n">mark</span> <span class="n">device</span> <span class="n">online</span> <span class="n">so</span> <span class="n">users</span> <span class="n">can</span> <span class="n">control</span>
      <span class="n">device</span><span class="p">:</span><span class="n">online</span><span class="p">()</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">thingclient</span> <span class="n">then</span>
    <span class="o">--</span> <span class="n">tell</span> <span class="n">device</span> <span class="n">health</span> <span class="n">to</span> <span class="n">mark</span> <span class="n">device</span> <span class="n">offline</span> <span class="n">so</span> <span class="n">users</span> <span class="n">will</span> <span class="n">see</span> <span class="n">that</span> <span class="n">it</span>
    <span class="o">--</span> <span class="n">can</span><span class="s1">&#39;t currenly be controlled</span>
    <span class="n">device</span><span class="p">:</span><span class="n">offline</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="s2">&quot;unable to reach thing&quot;</span>
  <span class="n">end</span>

  <span class="k">return</span> <span class="n">thingclient</span>
<span class="n">end</span>
</pre></div>
</div>
<p>This function is first checking whether there is already an rpcclient handle
stored in the device; if there is, it reuses that.  If not, it performs a
network discovery searching for only our Thing by its ID.  If the Thing is
found, it uses the IP and port information to make a new client connection and
marks the device as online. If there’s not an active connection and it’s unable
to find it on the network, it marks our Thing as offline. It then returns the
client if one now exists.</p>
<p>It’s helpful to abstract this out because we’ll be using this in a few different
places.</p>
<p>The first place we’ll use it is in the device initialization callback. This is
the first device lifecycle event we’ll handle. First, create a dedicated
function for this callback, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">initialize</span> <span class="n">device</span> <span class="n">at</span> <span class="n">startup</span> <span class="ow">or</span> <span class="n">when</span> <span class="n">added</span>
<span class="n">local</span> <span class="n">function</span> <span class="n">device_init</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">..</span> <span class="n">tostring</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">..</span> <span class="s2">&quot;] Initializing ThingSim RPC Client device&quot;</span><span class="p">)</span>

  <span class="n">local</span> <span class="n">client</span> <span class="o">=</span> <span class="n">get_thing_client</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">client</span> <span class="n">then</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected&quot;</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
      <span class="s2">&quot;Device not found at initial discovery (no async events until controlled)&quot;</span><span class="p">,</span>
      <span class="n">device</span><span class="p">:</span><span class="n">get_field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">device</span><span class="o">.</span><span class="n">device_network_id</span>
    <span class="p">)</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>This calls our full-featured discovery function to see if anything was found. We
can be confident that nothing was already saved because this handler is only
ever called by the underlying system when a new <code class="docutils literal notranslate"><span class="pre">Device</span></code> is created, either at
driver startup or when a new device is added.</p>
<p>Now we will add another handler for when a new device is added. All we’re going
to do is log, but this can be helpful for debugging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">handle</span> <span class="n">setup</span> <span class="k">for</span> <span class="n">newly</span> <span class="n">added</span> <span class="n">devices</span> <span class="p">(</span><span class="n">before</span> <span class="n">device_init</span><span class="p">)</span>
<span class="n">local</span> <span class="n">function</span> <span class="n">device_added</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">..</span> <span class="n">tostring</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">..</span> <span class="s2">&quot;] New ThingSim RPC Client device added&quot;</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>To actually use these handlers we’ll need to add them to our driver handers
table. Here we’ve added the <code class="docutils literal notranslate"><span class="pre">lifecycle_handlers</span></code> table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">example_driver</span> <span class="o">=</span>
  <span class="n">Driver</span><span class="p">(</span><span class="s2">&quot;example_driver&quot;</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">lifecycle_handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">device_added</span><span class="p">,</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">device_init</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">capability_handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
          <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle_on</span><span class="p">,</span>
          <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">switch</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">off</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle_off</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
</pre></div>
</div>
<p>Now our driver works for any device that’s already added. But we have no way to
add devices yet. Let’s add a discovery handler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">discover</span> <span class="ow">not</span> <span class="n">already</span> <span class="n">known</span> <span class="n">devices</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">the</span> <span class="n">network</span>
<span class="n">local</span> <span class="n">function</span> <span class="n">discovery_handler</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">should_continue</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting discovery&quot;</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">known_devices</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">local</span> <span class="n">found_devices</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">local</span> <span class="n">device_list</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">get_device_list</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">device_uuid</span> <span class="ow">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">device_list</span><span class="p">)</span> <span class="n">do</span>
    <span class="n">local</span> <span class="n">device</span> <span class="o">=</span> <span class="n">driver</span><span class="p">:</span><span class="n">get_device_info</span><span class="p">(</span><span class="n">device_uuid</span><span class="p">)</span>
    <span class="n">local</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">device_network_id</span>
    <span class="n">known_devices</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">end</span>

  <span class="k">while</span> <span class="n">should_continue</span><span class="p">()</span> <span class="n">do</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;making discovery request&quot;</span><span class="p">)</span>
    <span class="n">discovery</span><span class="o">.</span><span class="n">find_cb</span><span class="p">(</span>
      <span class="n">nil</span><span class="p">,</span> <span class="o">--</span> <span class="n">find</span> <span class="nb">all</span> <span class="n">things</span>
      <span class="n">function</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">local</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">id</span>
        <span class="n">local</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">ip</span>
        <span class="n">local</span> <span class="n">name</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;Unnamed ThingSim RPC Client&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">known_devices</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found_devices</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="n">then</span>
          <span class="n">found_devices</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">true</span>
          <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;adding </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="ow">or</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>
          <span class="k">assert</span><span class="p">(</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">create_device</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">({</span>
              <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;LAN&quot;</span><span class="p">,</span>
              <span class="n">deviceNetworkId</span> <span class="o">=</span> <span class="nb">id</span><span class="p">,</span>
              <span class="n">label</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
              <span class="n">parentDeviceId</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span>
              <span class="n">profileReference</span> <span class="o">=</span> <span class="s2">&quot;thingsim.onoff.v1&quot;</span><span class="p">,</span>
              <span class="n">manufacturer</span> <span class="o">=</span> <span class="s2">&quot;thingsim&quot;</span><span class="p">,</span>
              <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;On/Off Bulb&quot;</span><span class="p">,</span>
              <span class="n">vendorProvidedName</span> <span class="o">=</span> <span class="n">name</span>
            <span class="p">})),</span>
            <span class="s2">&quot;failed to send found_device&quot;</span>
          <span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="p">)</span>
  <span class="n">end</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exiting discovery&quot;</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Just like before, add this handler to our driver’s list of handlers inserting
this again at the top level:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">discovery</span> <span class="o">=</span> <span class="n">discovery_handler</span><span class="p">,</span>
</pre></div>
</div>
<p>And with that our basic driver is complete! Your <code class="docutils literal notranslate"><span class="pre">init.lua</span></code> file should now
look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>-- smartthings libraries
local capabilities = require &quot;st.capabilities&quot;
local Driver = require &quot;st.driver&quot;

-- the coroutine runtime and its socket interface
local cosock = require &quot;cosock&quot;
local socket = cosock.socket

-- driver specific libraries from this repo
--
-- note that we&#39;re using `cosock.asyncify` rather than `require` for these,
-- `asyncify` works just like `require` but it will replace any calls to
-- `require &quot;socket&quot;` with cosock&#39;s async socket interface so that our
-- blocking libaray is magically transformed into a non-blocking library
local client = cosock.asyncify &quot;rpcclient&quot;
local discovery = cosock.asyncify &quot;discovery&quot;

-- required for temporary use of internal device create API
local json = require &quot;dkjson&quot;

--------------------------------------------------------------------------------
-- Local Helpers
--------------------------------------------------------------------------------

-- search network for specific thing using custom discovery library
--
-- TODO: make this more efficient, this currently sends out an SSDP broadcast for
-- each thing, we should coalesce these to just send out a single request for the
-- whole driver
local function find_thing(id)
  -- use our custom discovery function to find the device with the specified ID
  local things = discovery.find({id})
  if not things then
    -- return early if discovery fails
    return nil
  end
  -- return the first (and presumably only) thing we found
  return table.remove(things)
end

-- get an rpc client for thing if thing is reachable on the network
local function get_thing_client(device)
  local thingclient = device:get_field(&quot;client&quot;)

  if not thingclient then
    local thing = find_thing(device.device_network_id)
    if thing then
      thingclient = client.new(thing.ip, thing.rpcport)
      device:set_field(&quot;client&quot;, client)

      -- tell device health to mark device online so users can control
      device:online()
    end
  end

  if not thingclient then
    -- tell device health to mark device offline so users will see that it
    -- can&#39;t currenly be controlled
    device:offline()

    return nil, &quot;unable to reach thing&quot;
  end

  return thingclient
end

--------------------------------------------------------------------------------
-- Device and Driver Event Handlers
--------------------------------------------------------------------------------

-- handle setup for newly added devices (before device_init)
local function device_added(driver, device)
  log.info(&quot;[&quot;..tostring(device.id)..&quot;] New ThingSim RPC Client device added&quot;)

  -- nothing to do here, everything happens in init this is just here for
  -- completeness, if you don&#39;t need this callback you can remove it
end

-- initialize device at startup or when added
local function device_init(driver, device)
  log.info(&quot;[&quot;..tostring(device.id)..&quot;] Init ThingSim RPC Client device&quot;)

  local thing = find_thing(device.device_network_id)

  if thing then
    local c = client.new(thing.ip, thing.rpcport)

    device:set_field(&quot;client&quot;, c)
    log.info(&quot;Connected&quot;)
  else
    log.warn(
      &quot;Device not found at initial discovery (no async events until controlled)&quot;,
      device:get_field(&quot;name&quot;) or device.device_network_id
    )
  end
end

-- discover not already known devices listening on the network
local function discovery_handler(driver, options, should_continue)
  log.info(&quot;starting discovery&quot;)
  local known_devices = {}
  local found_devices = {}

  local device_list = devices.get_device_list()
  for i, device_uuid in ipairs(device_list) do
    local device = driver:get_device_info(device_uuid)
    local id = device.device_network_id
    known_devices[id] = true
  end

  while should_continue() do
    log.info(&quot;making discovery request&quot;)
    discovery.find_cb(
      nil, -- find all things
      function(device)
        local id = device.id
        local ip = device.ip
        local name = device.name or &quot;Unnamed ThingSim RPC Client&quot;

        if not known_devices[id] and not found_devices[id] then
          found_devices[id] = true
          log.info(string.format(&quot;adding %s at %s&quot;, name or id, ip))
          assert(
            devices.create_device(json.encode({
              type = &quot;LAN&quot;,
              deviceNetworkId = id,
              label = name,
              parentDeviceId = nil,
              profileReference = &quot;thingsim.onoff.v1&quot;,
              manufacturer = &quot;thingsim&quot;,
              model = &quot;On/Off Bulb&quot;,
              vendorProvidedName = name
            })),
            &quot;failed to send found_device&quot;
          )
        end
      end
    )
  end
  log.info(&quot;exiting discovery&quot;)
end

--------------------------------------------------------------------------------
-- Command Handlers
--------------------------------------------------------------------------------

function handle_switch_on(driver, device, somethingmaybe)
  log.info(&quot;switch on&quot;, device.id)

  local client = assert(get_thing_client(device))
  if client:setattr{power = &quot;on&quot;} then
    device:emit_event(capabilities.switch.switch.on())
  else
    log.error(&quot;failed to set power on&quot;)
  end
end

function handle_switch_off(driver, device, somethingmaybe)
  log.info(&quot;switch off&quot;, device.id)

  local client = assert(get_thing_client(device))
  if client:setattr{power = &quot;off&quot;} then
    device:emit_event(capabilities.switch.switch.off())
  else
    log.error(&quot;failed to set power on&quot;)
  end
end

--------------------------------------------------------------------------------
-- Build and Run Driver
--------------------------------------------------------------------------------

local rpc_client_driver = Driver(&quot;rpc client&quot;,
  {
    discovery = discovery_handler,
    lifecycle_handlers = {
      added = device_added,
      init = device_init,
    },
    capability_handlers = {
      [capabilities.switch.ID] = {
        [capabilities.switch.commands.on.NAME] = handle_switch_on,
        [capabilities.switch.commands.off.NAME] = handle_switch_off
      },
    }
  }
)

rpc_client_driver.bulb_handles = {}

rpc_client_driver:run()
</pre></div>
</div>
<p>Next, publish &amp; install your new driver using the <a class="reference external" href="https://github.com/SmartThingsCommunity/smartthings-cli">SmartThings CLI</a>, make sure the
ThingSim daemon is running; if not ,run it with <code class="docutils literal notranslate"><span class="pre">thingsim</span> <span class="pre">run</span></code> and perform a
“Scan Nearby” in the SmartThings app. Your ThingSim Things should pop up moments
after you start.</p>
<p>Congratulations, you have now written your own SmartThings Edge Driver,
installed it on a Hub, and put it to use. You now know everything needed to
write a SmartThings Edge Driver for any LAN device that exposes a similar API.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../reference/index.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lan.html" class="btn btn-neutral" title="LAN Edge Device Driver Development Guide" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, SmartThings Developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>